=====
Adyen
=====

`Adyen <https://www.adyen.com/>`_ is a Dutch company that offers several online payment
possibilities.

.. seealso::
   - :ref:`payment_providers/add_new`
   - :doc:`../payment_providers`

.. note::
   Adyen works only with customers processing **more** than **10 million annually** or invoicing a
   **minimum** of **1.000** transactions **per month**.

.. _adyen-configuration:

Configuration
=============

.. seealso::
   :ref:`payment_providers/add_new`

Credentials tab
---------------

Odoo needs your **API Credentials** to connect with your Adyen account, which comprise:

- **Merchant Account**: The code of the merchant account to use with Adyen.
- :ref:`API Key <adyen/api_and_client_keys>`: The API key of the webservice user.
- :ref:`Client Key <adyen/api_and_client_keys>`: The client key of the webservice user.
- :ref:`HMAC Key <adyen/hmac_key>`: The HMAC key of the webhook.
- :ref:`Checkout API URL <adyen/urls>`: The base URL for the Checkout API endpoints.
- :ref:`Recurring API URL <adyen/urls>`: The base URL for the Recurring API endpoints.

You can copy your credentials from your Adyen account, and paste them in the related fields under
the **Credentials** tab.

.. important::
   If you are trying Adyen as a test, with an Adyen *test account*, head to
   :menuselection:`Accounting --> Configuration --> Payment Providers`. There, click on
   :guilabel:`Adyen`, enable :guilabel:`Test Mode` and enter your credentials in the
   :guilabel:`Credentials` tab.

.. _adyen/api_and_client_keys:

API Key and Client Key
~~~~~~~~~~~~~~~~~~~~~~

In order to retrieve the API Key and the Client Key, log into your Adyen account, go to
:menuselection:`Developers --> API Credentials`.

- If you already have an API user, open it.
- If you don't have an API user yet, click on **Create new credential**.

Go to :menuselection:`Server settings --> Authentification` and copy or generate your **API Key**.
Be careful to copy your API key as you'll not be allowed to get it later without generating a new
one.

Now, head to :menuselection:`Client settings --> Authentification` and cody or generate your
**Client Key**. This is also the place where you can :ref:`allow payments to be made from your
website <adyen/allowed_origins>`.

.. _adyen/hmac_key:

HMAC key
~~~~~~~~

In order to retrieve the HMAC Key, you'll need to configure a `Standard Notification` webhook. For
this, log into your Adyen account then go to :menuselection:`Developers --> Webhooks --> Add webhook
--> Add Standard notification`.

.. image:: adyen/adyen-add-webhook.png
   :align: center
   :alt: Configure a webhook.

There, in :menuselection:`General --> Server configuration --> URL`, enter your server address
followed by `/payment/adyen/notification`.

.. image:: adyen/adyen-webhook-url.png
   :align: center
   :alt: Enter the notification URL.

Then enter :menuselection:`Security --> HMAC Key --> Generate`. Be careful to copy the key as you
will not be allowed to do it later without generating a new one.

.. image:: adyen/adyen-hmac-key.png
   :align: center
   :alt: Generate a HMAC key and save it.

You have to save the webhook to finalize its creation.

.. _adyen/urls:

API URLs
~~~~~~~~

All Adyen API URLs include a customer area-specific prefix generated by Adyen. To configure the
URLs, proceed as follows:

#. Log into your Adyen account, then go to :menuselection:`Developers --> API URLs`.
#. Copy the :guilabel:`Prefix` for your live Customer area (i.e., **data center**) and save it for
   later.

   .. image:: adyen/adyen-api-urls.png
     :alt: Copy the prefix for the Adyen APIs

#. In Odoo, :ref:`navigate to the payment provider Adyen <payment_providers/add_new>`.
#. In the :guilabel:`Checkout API URL` field, enter the following URL and replace `yourprefix` with
   the prefix you previously saved:
   `https://yourprefix-checkout-live.adyenpayments.com/checkout`
#. In the :guilabel:`Recurring API URL` field, enter the following URL and replace `yourprefix` with
   the prefix you previously saved:
   `https://yourprefix-pal-live.adyenpayments.com/pal/servlet/Recurring`.

.. note::
   If you are trying Adyen as a test, you can use the following URLs instead:

   - :guilabel:`Checkout API URL`: `https://checkout-test.adyen.com`
   - :guilabel:`Recurring API URL`: `https://pal-test.adyen.com/pal/servlet/Recurring`

Adyen Account
-------------

.. _adyen/allowed_origins:

Allow payments from a specific origin
~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

To allow payment originated from your website, follow the steps in :ref:`adyen/api_and_client_keys`
to navigate to your API user and go to :menuselection:`Add allowed origins`, then add the URLs from
where payments will be made (the URLs of the servers hosting your Odoo instances).

.. image:: adyen/adyen-allowed-origins.png
   :align: center
   :alt: Allows payments originated from a specific domain.

Place a hold on a card
----------------------

Adyen allows you to capture an amount manually instead of having an immediate capture.

To set it up, enable the **Capture Amount Manually** option on Odoo, as explained in the
:ref:`payment providers documentation <payment_providers/features/manual_capture>`.

Then, open your Adyen Merchant Account, go to :menuselection:`Account --> Settings`, and set the
**Capture Delay** to **manual**.

.. image:: adyen/adyen_capture_delay.png
   :align: center
   :alt: Capture Delay settings in Adyen

.. caution::
   - If you configure Odoo to capture amounts manually, make sure to set the **Capture Delay** to
     **manual** on Adyen. Otherwise, the transaction will be blocked in the authorized state in
     Odoo.
   - Odoo doesn't support the partial capture yet. Be aware that if you make a partial capture from
     Adyen's interface, Odoo will manage it as if it was a full capture.

.. note::
   After **7 days**, if the transaction hasn't been captured yet, the customer has the right to
   **revoke** it.

.. seealso::
   :doc:`../payment_providers`

Express Checkout
================

Express checkout allows customers to pay for their products in a single click. Odoo supports Apple
Pay and Google Pay as express checkout methods through Adyen.

Apple Pay with Adyen
--------------------

To enable Apple Pay with Adyen, you must first complete the prerequisites below.
After meeting the prerequisites, see the :ref:`Odoo setup steps <adyen-apple-steps>`.

Prerequisites
~~~~~~~~~~~~~

.. |payment-processing-csr| replace::
  In a new browser window, log in to Adyen. Then, go to :menuselection:`Developers --> API credentials`,
  select your Adyen web service account, and scroll down to :guilabel:`Wallet payment methods`. Add a new
  :guilabel:`Apple Pay Certificate`, selecting :guilabel:`Use your own certificate`. Follow the prompts and
  then click :guilabel:`Download CSR`. Upload the CSR to Apple, download the certificate from Apple by clicking
  :guilabel:`Download`, and upload this certificate to Adyen.

.. include:: apple_pre.rst

.. _adyen-apple-steps:

Steps
~~~~~

Now, in Odoo:

- :ref:`Configure Adyen <adyen-configuration>`.
- Install the `express_payment_adyen_apple` Odoo module.
- Open the Odoo configuration page for Adyen.
- Enter your Apple Pay merchant ID in the field :guilabel:`Merchant ID`.
- Upload the domain verification file :file:`apple-developer-merchantid-domain-association.txt`.
- Upload the merchant identity certificate :file:`merchant_id.cer`.
- Upload the merchant identity key :file:`merchant.p12`.
- Back in your Apple Developer Account, click the :guilabel:`Verify` button on the domain
  verification page.

At this point, the Apple Pay button will appear in the eCommerce cart.

.. important::
   If you are running Adyen in test mode, you must use `Apple Pay test cards <https://developer.apple.com/apple-pay/sandbox-testing>`_.
   Adyen will reject Apple Pay payments made from real credit cards when running in test mode.

Disable Apple Pay
~~~~~~~~~~~~~~~~~

To disable Apple Pay with Adyen, simply uninstall the `express_payment_adyen_apple`
Odoo module.

Google Pay with Adyen
--------------------

To enable Google Pay with Adyen, you must first complete the prerequisites below.
After meeting the prerequisites, see the :ref:`Odoo setup steps <adyen-google-steps>`.

Prerequisites
~~~~~~~~~~~~~

Before enabling Google Pay in Odoo, do the following:

- In Adyen, navigate to :menuselection:`Developers --> API credentials`.
- Select your Adyen web service account.
- Scroll down to :guilabel:`Wallet payment methods`.
- Next to :guilabel:`Google Pay certificate`, click :guilabel:`Add`.
- Click :guilabel:`Generate certificate` and then :guilabel:`Download certificate`.

This is sufficient for performing test transactions. If you are setting up Google Pay
for production, complete the following additional prerequisites:

- Register for a `Google Business account <https://www.google.com/business>`_.
- From your business dashboard, navigate to the :guilabel:`Google Pay API`.
- Under :guilabel:`Integrate with your website`, click :guilabel:`Add website`.
- Enter your website URL, select :guilabel:`Gateway` as the integration type, and upload
  the necessary screenshots.
- Click :guilabel:`Save` and then submit your integration for approval.

.. _adyen-google-steps:

Steps
~~~~~

Now, in Odoo:

- :ref:`Configure Adyen <adyen-configuration>`.
- Install the `express_payment_adyen_google` Odoo module.

This is sufficient for performing test transactions. If you are setting up Google Pay
for production, complete the following additional steps:

- Open the Odoo configuration page for Adyen.
- Enter your Google Pay merchant ID in the field :guilabel:`Merchant ID`.

At this point, the Google Pay button will appear in the eCommerce cart.

Disable Google Pay
~~~~~~~~~~~~~~~~~

To disable Google Pay with Adyen, simply uninstall the `express_payment_adyen_google`
Odoo module.
